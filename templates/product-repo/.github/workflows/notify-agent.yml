name: Notify Agent

on:
  workflow_run:
    workflows: [CI, Deploy Preview]
    types: [completed]

jobs:
  notify:
    name: Notify Agent of Results
    runs-on: ubuntu-latest
    if: github.event.workflow_run.head_branch == 'agent-runtime'
    steps:
      - name: Get workflow conclusion
        id: conclusion
        run: |
          echo "result=${{ github.event.workflow_run.conclusion }}" >> $GITHUB_OUTPUT
          echo "workflow=${{ github.event.workflow_run.name }}" >> $GITHUB_OUTPUT

      - name: Get workflow logs on failure
        if: github.event.workflow_run.conclusion == 'failure'
        id: logs
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: ${{ github.event.workflow_run.id }}
            });

            const failedJobs = jobs.data.jobs.filter(job => job.conclusion === 'failure');
            let errorSummary = '';

            for (const job of failedJobs) {
              errorSummary += `### ${job.name}\n`;

              // Get job logs
              try {
                const logs = await github.rest.actions.downloadJobLogsForWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  job_id: job.id
                });

                // Extract last 100 lines of logs
                const logLines = logs.data.split('\n').slice(-100).join('\n');
                errorSummary += '```\n' + logLines + '\n```\n\n';
              } catch (e) {
                errorSummary += 'Could not fetch logs\n\n';
              }
            }

            core.setOutput('error_summary', errorSummary);

      - name: Find associated issue
        id: find_issue
        uses: actions/github-script@v7
        with:
          script: |
            // Look for open issues with agent-task label
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'agent-task',
              state: 'open',
              per_page: 1
            });

            if (issues.data.length > 0) {
              core.setOutput('issue_number', issues.data[0].number);
              return issues.data[0].number;
            }

            core.setOutput('issue_number', '');
            return null;

      - name: Comment on issue (failure)
        if: github.event.workflow_run.conclusion == 'failure' && steps.find_issue.outputs.issue_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.find_issue.outputs.issue_number }};
            const workflow = '${{ github.event.workflow_run.name }}';
            const runUrl = '${{ github.event.workflow_run.html_url }}';
            const errorSummary = `${{ steps.logs.outputs.error_summary }}`;

            const body = `## CI Failure: ${workflow}

            The workflow has failed. Please review and fix the errors.

            **Run URL:** ${runUrl}

            ## Error Summary
            ${errorSummary}

            ---
            *This comment was automatically generated by the CI notification workflow.*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: body
            });

      - name: Comment on issue (success)
        if: github.event.workflow_run.conclusion == 'success' && steps.find_issue.outputs.issue_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.find_issue.outputs.issue_number }};
            const workflow = '${{ github.event.workflow_run.name }}';
            const runUrl = '${{ github.event.workflow_run.html_url }}';

            const body = `## CI Success: ${workflow}

            The workflow completed successfully.

            **Run URL:** ${runUrl}

            ---
            *This comment was automatically generated by the CI notification workflow.*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: body
            });

      - name: Update job summary
        run: |
          echo "## Workflow Notification" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.event.workflow_run.name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Result:** ${{ github.event.workflow_run.conclusion }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.event.workflow_run.head_branch }}" >> $GITHUB_STEP_SUMMARY
