name: Stop Agent on Issue Close

on:
  issues:
    types: [closed]

permissions:
  issues: write
  contents: read

jobs:
  stop-agent-container:
    runs-on: ubuntu-latest
    # Only run for issues that had agent activity
    if: |
      contains(github.event.issue.labels.*.name, 'agent-building') ||
      contains(github.event.issue.labels.*.name, 'agent-complete') ||
      contains(github.event.issue.labels.*.name, 'tests-failed')

    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/vps_key
          chmod 600 ~/.ssh/vps_key
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Stop agent container via SSH
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_SSH_USER: ${{ secrets.VPS_SSH_USER }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          echo "Processing issue #$ISSUE_NUMBER closure"

          # Check container status
          CONTAINER_STATUS=$(ssh -i ~/.ssh/vps_key ${VPS_SSH_USER}@${VPS_HOST} \
            "docker inspect claude-code-agent --format '{{.State.Status}}' 2>/dev/null || echo 'not_found'")

          echo "Container status: $CONTAINER_STATUS"

          if [ "$CONTAINER_STATUS" = "running" ]; then
            # Check if this container is working on the closed issue
            CURRENT_ISSUE=$(ssh -i ~/.ssh/vps_key ${VPS_SSH_USER}@${VPS_HOST} \
              "cat /opt/agent/metrics/health.json 2>/dev/null | jq -r '.current_issue // empty'" || echo "")

            if [ "$CURRENT_ISSUE" = "$ISSUE_NUMBER" ]; then
              echo "Container is working on issue #$ISSUE_NUMBER - stopping..."

              # Stop the container
              ssh -i ~/.ssh/vps_key ${VPS_SSH_USER}@${VPS_HOST} \
                "docker stop claude-code-agent && docker rm claude-code-agent" || true

              # Clear the metrics file
              ssh -i ~/.ssh/vps_key ${VPS_SSH_USER}@${VPS_HOST} \
                "echo '{}' > /opt/agent/metrics/health.json" || true

              echo "Container stopped successfully"
              STOP_STATUS="stopped"
            else
              echo "Container is working on different issue (#$CURRENT_ISSUE) - not stopping"
              STOP_STATUS="different_issue"
            fi
          else
            echo "Container not running"
            STOP_STATUS="not_running"
          fi

          # Post comment to issue
          WORKFLOW_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"

          if [ "$STOP_STATUS" = "stopped" ]; then
            COMMENT="**Agent Container Stopped**

The agent container working on this issue has been stopped.

| Field | Value |
|-------|-------|
| **Container** | \`claude-code-agent\` |
| **Action** | Stopped and removed |
| **Reason** | Issue closed |

---
*Automated by GitHub Actions*"
          elif [ "$STOP_STATUS" = "different_issue" ]; then
            COMMENT="**Issue Closed**

The agent container is currently working on a different issue (#$CURRENT_ISSUE) and was not stopped.

---
*Automated by GitHub Actions*"
          else
            COMMENT="**Issue Closed**

No agent container was running for this issue.

---
*Automated by GitHub Actions*"
          fi

          gh issue comment $ISSUE_NUMBER --repo $GITHUB_REPOSITORY --body "$COMMENT"
          echo "Posted status comment to issue"
