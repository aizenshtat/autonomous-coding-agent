name: Issue Poller

# Polls for approved issues every 5 minutes and triggers agent builds
# This enables reaction-based approval without requiring webhooks
# Also checks session health and restarts dead sessions

on:
  schedule:
    - cron: '*/5 * * * *'  # Every 5 minutes
  workflow_dispatch:  # Manual trigger for testing

# Prevent multiple pollers from running simultaneously
concurrency:
  group: issue-poller-singleton
  cancel-in-progress: false

permissions:
  issues: read
  actions: write
  contents: read

jobs:
  # Job 1: Check if an agent session died and needs restart
  check-session-health:
    runs-on: ubuntu-latest
    outputs:
      needs_restart: ${{ steps.health.outputs.needs_restart }}
      issue_number: ${{ steps.state.outputs.issue_number }}

    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/vps_key
          chmod 600 ~/.ssh/vps_key
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Check session heartbeat via SSH
        id: health
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_SSH_USER: ${{ secrets.VPS_SSH_USER }}
          STALENESS_THRESHOLD: ${{ vars.HEARTBEAT_STALENESS_SECONDS || '300' }}
        run: |
          # Read metrics file from VPS via SSH
          METRICS=$(ssh -i ~/.ssh/vps_key -o ConnectTimeout=10 ${VPS_SSH_USER}@${VPS_HOST} \
            "cat /opt/agent/metrics/health.json 2>/dev/null || echo '{}'")

          echo "Metrics from VPS: $METRICS"

          # Check if metrics file is empty or missing
          if [ "$METRICS" = "{}" ] || [ -z "$METRICS" ]; then
            echo "status=no_session" >> $GITHUB_OUTPUT
            echo "needs_restart=false" >> $GITHUB_OUTPUT
            echo "No active session detected (no metrics file)"
            exit 0
          fi

          # Check container status
          CONTAINER_STATUS=$(ssh -i ~/.ssh/vps_key ${VPS_SSH_USER}@${VPS_HOST} \
            "docker inspect claude-code-agent --format '{{.State.Status}}' 2>/dev/null || echo 'not_found'")

          echo "Container status: $CONTAINER_STATUS"

          if [ "$CONTAINER_STATUS" != "running" ]; then
            # Container not running - check if there's an issue that was being built
            CURRENT_ISSUE=$(echo "$METRICS" | jq -r '.current_issue // empty')
            if [ -n "$CURRENT_ISSUE" ]; then
              echo "status=dead" >> $GITHUB_OUTPUT
              echo "needs_restart=true" >> $GITHUB_OUTPUT
              echo "Container not running but metrics show issue #$CURRENT_ISSUE - needs restart"
            else
              echo "status=no_session" >> $GITHUB_OUTPUT
              echo "needs_restart=false" >> $GITHUB_OUTPUT
              echo "No active session (container not running, no current issue)"
            fi
            exit 0
          fi

          # Container is running - check heartbeat freshness
          LAST_HEARTBEAT=$(echo "$METRICS" | jq -r '.last_heartbeat // empty')

          if [ -z "$LAST_HEARTBEAT" ]; then
            echo "status=no_heartbeat" >> $GITHUB_OUTPUT
            echo "needs_restart=false" >> $GITHUB_OUTPUT
            echo "No heartbeat in metrics (container just started?)"
            exit 0
          fi

          # Calculate age in seconds
          HEARTBEAT_EPOCH=$(date -d "$LAST_HEARTBEAT" +%s 2>/dev/null || echo "0")
          NOW_EPOCH=$(date +%s)
          AGE_SECONDS=$((NOW_EPOCH - HEARTBEAT_EPOCH))

          echo "Heartbeat age: ${AGE_SECONDS}s (threshold: ${STALENESS_THRESHOLD}s)"

          if [ $AGE_SECONDS -gt $STALENESS_THRESHOLD ]; then
            echo "status=stale" >> $GITHUB_OUTPUT
            echo "needs_restart=true" >> $GITHUB_OUTPUT
            echo "Session heartbeat stale (${AGE_SECONDS}s old) - needs restart"
          else
            echo "status=healthy" >> $GITHUB_OUTPUT
            echo "needs_restart=false" >> $GITHUB_OUTPUT
            echo "Session healthy (heartbeat ${AGE_SECONDS}s old)"
          fi

      - name: Get current issue from metrics
        if: steps.health.outputs.needs_restart == 'true'
        id: state
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_SSH_USER: ${{ secrets.VPS_SSH_USER }}
        run: |
          ISSUE=$(ssh -i ~/.ssh/vps_key ${VPS_SSH_USER}@${VPS_HOST} \
            "cat /opt/agent/metrics/health.json 2>/dev/null | jq -r '.current_issue // empty'")

          if [ -n "$ISSUE" ] && [ "$ISSUE" != "null" ]; then
            echo "issue_number=$ISSUE" >> $GITHUB_OUTPUT
            echo "Found current issue: #$ISSUE"
          else
            echo "issue_number=" >> $GITHUB_OUTPUT
            echo "No current issue found in metrics"
          fi

      - name: Verify issue is open with agent-building label
        if: steps.health.outputs.needs_restart == 'true' && steps.state.outputs.issue_number != ''
        id: verify
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE="${{ steps.state.outputs.issue_number }}"

          # Get issue state and labels
          ISSUE_DATA=$(gh issue view "$ISSUE" -R ${{ github.repository }} --json state,labels 2>/dev/null || echo '{"state":"unknown"}')
          STATE=$(echo "$ISSUE_DATA" | jq -r '.state')
          HAS_BUILDING_LABEL=$(echo "$ISSUE_DATA" | jq -r '.labels[]?.name' | grep -q "agent-building" && echo "true" || echo "false")

          echo "Issue #$ISSUE: state=$STATE, has_agent-building=$HAS_BUILDING_LABEL"

          if [ "$STATE" != "OPEN" ]; then
            echo "should_restart=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ Issue #$ISSUE is not open (state: $STATE) - skipping restart"
          elif [ "$HAS_BUILDING_LABEL" != "true" ]; then
            echo "should_restart=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ Issue #$ISSUE doesn't have agent-building label - skipping restart"
          else
            echo "should_restart=true" >> $GITHUB_OUTPUT
            echo "âœ… Issue #$ISSUE is open with agent-building label - will restart"
          fi

      - name: Trigger restart workflow
        if: steps.health.outputs.needs_restart == 'true' && steps.state.outputs.issue_number != '' && steps.verify.outputs.should_restart == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ”„ Triggering restart for issue #${{ steps.state.outputs.issue_number }}..."

          gh workflow run agent-builder.yml \
            -R ${{ github.repository }} \
            -f issue_number=${{ steps.state.outputs.issue_number }} \
            -f resume_session=true

          echo "âœ… Triggered agent-builder with resume_session=true"

  # Job 2: Poll for new approved issues
  poll-and-trigger:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install PyGithub

      - name: Find approved issues and trigger builds
        id: poll
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          AUTHORIZED_APPROVERS: ${{ vars.AUTHORIZED_APPROVERS }}
        run: |
          python << 'EOF'
          import os
          import json
          from github import Github

          # Authorized approvers who can trigger builds with ðŸš€
          # Configure via AUTHORIZED_APPROVERS repository variable (comma-separated)
          _approvers_env = os.environ.get("AUTHORIZED_APPROVERS", "")
          AUTHORIZED_APPROVERS = set(a.strip() for a in _approvers_env.split(",") if a.strip())
          ROCKET_EMOJI = "rocket"
          LABEL_BUILDING = "agent-building"
          LABEL_COMPLETE = "agent-complete"
          LABEL_FAILED = "tests-failed"

          gh = Github(os.environ["GITHUB_TOKEN"])
          repo = gh.get_repo(os.environ["GITHUB_REPOSITORY"])

          # Get all open issues
          open_issues = list(repo.get_issues(state='open'))

          # First check if ANY issue has agent-building label (agent already running)
          for issue in open_issues:
              labels = [l.name for l in issue.labels]
              if LABEL_BUILDING in labels:
                  print(f"â¸ï¸ Agent already running on issue #{issue.number} - skipping trigger")
                  print("   The running agent will pick up new issues from the backlog")
                  with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                      f.write("approved_issues=[]\n")
                      f.write("has_issues=false\n")
                  exit(0)

          approved_issues = []

          for issue in open_issues:
              # Skip if complete or failed
              labels = [l.name for l in issue.labels]
              if LABEL_COMPLETE in labels:
                  continue

              # Check for rocket reaction from authorized staff
              reactions = issue.get_reactions()
              has_approval = False

              for reaction in reactions:
                  if reaction.content == ROCKET_EMOJI:
                      if reaction.user.login in AUTHORIZED_APPROVERS:
                          has_approval = True
                          print(f"âœ… Issue #{issue.number}: Approved by {reaction.user.login}")
                          break

              if has_approval:
                  approved_issues.append({
                      "number": issue.number,
                      "title": issue.title,
                      "votes": sum(1 for r in issue.get_reactions() if r.content == "+1")
                  })

          # Sort by votes (highest first), then by issue number as tiebreaker
          approved_issues.sort(key=lambda x: (-x["votes"], x["number"]))

          print(f"\nFound {len(approved_issues)} approved issues to build:")
          for issue in approved_issues:
              print(f"  - Issue #{issue['number']}: {issue['title']} ({issue['votes']} votes)")

          # Output for next step
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"approved_issues={json.dumps([i['number'] for i in approved_issues])}\n")
              f.write(f"has_issues={'true' if approved_issues else 'false'}\n")
          EOF

      - name: Trigger agent-builder for approved issues
        if: steps.poll.outputs.has_issues == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          APPROVED_ISSUES: ${{ steps.poll.outputs.approved_issues }}
        run: |
          # Only trigger for the FIRST approved issue
          # The running agent will pick up additional issues via its polling mechanism
          # This prevents race conditions and reduces unnecessary workflow runs
          FIRST_ISSUE=$(echo "$APPROVED_ISSUES" | jq -r '.[0]')

          if [ -n "$FIRST_ISSUE" ] && [ "$FIRST_ISSUE" != "null" ]; then
            echo "Triggering build for issue #$FIRST_ISSUE..."
            echo "(Other approved issues will be picked up by the running agent)"

            gh workflow run agent-builder.yml \
              -f issue_number=$FIRST_ISSUE \
              -f force_rebuild=false

            echo "âœ… Triggered agent-builder for issue #$FIRST_ISSUE"
          fi
