version: '3.8'

# VPS Docker Compose for Long-Horizon Coding Agent
# Run with: docker compose up -d
# Build with: docker compose build

services:
  claude-code-agent:
    build:
      context: .
      dockerfile: Dockerfile.vps
    image: claude-code-agent:latest
    container_name: claude-code-agent

    # VPS entrypoint - receives config via environment
    command: >
      sh -c "cp -r /app/prompts /app/workspace/ 2>/dev/null || true &&
             cp -r /app/frontend-scaffold-template /app/workspace/ 2>/dev/null || true &&
             python vps_entrypoint.py"

    # Volume mounts for VPS deployment
    volumes:
      # Persistent workspace for git repos
      - /opt/agent/data:/app/workspace
      # Metrics for health checks (read by GitHub Actions via SSH)
      - /opt/agent/metrics:/app/metrics
      # Preview builds (served by nginx)
      - /opt/agent/previews:/app/previews
      # Secrets (read-only)
      - /opt/agent/secrets:/app/secrets:ro

    # Environment variables
    environment:
      - PROJECT_ROOT=/app/workspace
      - METRICS_FILE=/app/metrics/health.json
      - GITHUB_TOKEN_FILE=/app/secrets/github_token
      # Authentication: Use OAuth token (subscription) OR API key, not both
      # OAuth token is preferred for Pro/Max subscription
      - CLAUDE_CODE_OAUTH_TOKEN_FILE=/app/secrets/claude_oauth_token
      # API key is fallback for pay-as-you-go (only used if OAuth token not present)
      - ANTHROPIC_API_KEY_FILE=/app/secrets/anthropic_api_key
      - DEFAULT_MODEL=${DEFAULT_MODEL:-claude-opus-4-5-20251101}
      - SESSION_DURATION_HOURS=7.0
      # These are set by ssh_invoke.py when starting the container:
      # - SESSION_ID=...
      # - AGENT_PAYLOAD=...

    # Network configuration
    network_mode: host

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 16G
        reservations:
          cpus: '2.0'
          memory: 8G

    # Restart policy
    restart: unless-stopped

    # Health check based on metrics file
    healthcheck:
      test: ["CMD", "python", "-c", "import json; import os; f=open('/app/metrics/health.json'); d=json.load(f); exit(0 if d.get('status') != 'error' else 1)"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 120s

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"

# Local development service (optional)
  # claude-code-local:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile.vps
  #   container_name: claude-code-local
  #   command: >
  #     python claude_code.py
  #     --project ${PROJECT_NAME:-canopy}
  #     --model ${DEFAULT_MODEL:-claude-opus-4-5-20251101}
  #   volumes:
  #     - .:/app/workspace
  #   environment:
  #     - PROJECT_ROOT=/app/workspace
  #     - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
  #   network_mode: host
